machine:
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"

  override:
    - docker info
    - sudo pip install -U docker-compose==1.2.0
    - cp src/db/secrets.example.env src/db/secrets.env
    # If there's a base image cached, load it.
    # A click on CircleCI's "Clear Cache" will make sure we start with a clean slate.
    - mkdir -p ~/docker
    - if [[ -e ~/docker/images.tar ]]; then docker load -i ~/docker/images.tar; fi
    # If cache doesn't exist, pull the base images so we can easily save them later
    - if [[ ! -e ~/docker/images.tar ]]; then docker pull leaguewinspool/webapp-base:latest; fi
    - if [[ ! -e ~/docker/images.tar ]]; then docker pull mysql:5.6; fi
    - if [[ ! -e ~/docker/images.tar ]]; then docker pull nginx:1.9.0; fi
    - (cd src; docker-compose -f docker-production.yml build)
    # Otherwise, we built one above, and save it.
    - if [[ ! -e ~/docker/images.tar ]]; then docker save -o ~/docker/images.tar leaguewinspool/webapp-base:latest mysql:5.6 nginx:1.9.0; fi
    # Print the history so that we can investigate potential steps which fatten
    # the image needlessly.
    - docker history src_webapp
    - (cd src; docker-compose -f docker-production.yml up -d)

test:
  override:
    - (cd src; docker-compose -f docker-production.yml run webapp grunt test --gruntfile /webapp/client/Gruntfile.js)
